Perfect ğŸ‘ I will now give you **copy-paste ready content** for:

```
modules/pubsub/
    main.tf
    variables.tf
    outputs.tf

root/
    main.tf
    variables.tf

tfvars/
    mics-hcb-dev.tfvars (pubsub section only)
```

âš ï¸ This strictly follows your GCS pattern:

* for_each
* map(object())
* each.key naming
* project_id passed
* keys() in outputs
* no deviation from your working structure

---

# ================================

# ğŸ“ modules/pubsub/main.tf

# ================================

```hcl
resource "google_pubsub_topic" "this" {
  for_each = var.topics

  name    = each.key
  project = var.project_id

  labels  = each.value.labels

  message_retention_duration = each.value.message_retention_duration
}


resource "google_pubsub_subscription" "this" {
  for_each = var.subscriptions

  name    = each.key
  project = var.project_id

  topic   = google_pubsub_topic.this[each.value.topic_name].id

  ack_deadline_seconds       = each.value.ack_deadline_seconds
  message_retention_duration = each.value.message_retention_duration
  retain_acked_messages      = each.value.retain_acked_messages
  enable_message_ordering    = each.value.enable_message_ordering

  labels = each.value.labels

  dynamic "dead_letter_policy" {
    for_each = each.value.dead_letter_enabled ? [1] : []
    content {
      dead_letter_topic     = google_pubsub_topic.this[each.value.dead_letter_topic].id
      max_delivery_attempts = each.value.max_delivery_attempts
    }
  }
}
```

---

# ================================

# ğŸ“ modules/pubsub/variables.tf

# ================================

```hcl
variable "project_id" {
  type        = string
  description = "Project ID"
}


variable "topics" {
  type = map(object({
    labels                     = map(string)
    message_retention_duration = string
  }))
}


variable "subscriptions" {
  type = map(object({
    topic_name                 = string
    ack_deadline_seconds       = number
    message_retention_duration = string
    retain_acked_messages      = bool
    enable_message_ordering    = bool
    labels                     = map(string)

    dead_letter_enabled        = bool
    dead_letter_topic          = string
    max_delivery_attempts      = number
  }))
}
```

---

# ================================

# ğŸ“ modules/pubsub/outputs.tf

# ================================

```hcl
output "topic_names" {
  value = keys(google_pubsub_topic.this)
}

output "subscription_names" {
  value = keys(google_pubsub_subscription.this)
}
```

---

# ================================

# ğŸ“ root/main.tf

# ================================

Add this below your GCS module block:

```hcl
module "pubsub" {
  source = "./modules/pubsub"

  project_id    = var.project_id
  topics        = var.pubsub_topics
  subscriptions = var.pubsub_subscriptions
}
```

---

# ================================

# ğŸ“ root/variables.tf

# ================================

Add these two variables:

```hcl
variable "pubsub_topics" {
  type = map(object({
    labels                     = map(string)
    message_retention_duration = string
  }))
}
```

```hcl
variable "pubsub_subscriptions" {
  type = map(object({
    topic_name                 = string
    ack_deadline_seconds       = number
    message_retention_duration = string
    retain_acked_messages      = bool
    enable_message_ordering    = bool
    labels                     = map(string)

    dead_letter_enabled        = bool
    dead_letter_topic          = string
    max_delivery_attempts      = number
  }))
}
```

---

# ================================

# ğŸ“ tfvars/mics-hcb-dev.tfvars

# ================================

Add this below your existing gcs_buckets block:

```hcl
pubsub_topics = {

  "dev-orders-topic" = {
    message_retention_duration = "604800s"

    labels = {
      environment = "dev"
      managed-by  = "terraform"
    }
  }

  "dev-dlq-topic" = {
    message_retention_duration = "604800s"

    labels = {
      environment = "dev"
      managed-by  = "terraform"
    }
  }
}
```

Now subscriptions:

```hcl
pubsub_subscriptions = {

  "dev-orders-sub" = {
    topic_name                 = "dev-orders-topic"
    ack_deadline_seconds       = 20
    message_retention_duration = "604800s"
    retain_acked_messages      = false
    enable_message_ordering    = false

    labels = {
      environment = "dev"
      managed-by  = "terraform"
    }

    dead_letter_enabled   = true
    dead_letter_topic     = "dev-dlq-topic"
    max_delivery_attempts = 5
  }
}
```

---

# âœ… What Happens When You Run Plan

It will create:

Topic:

* dev-orders-topic
* dev-dlq-topic

Subscription:

* dev-orders-sub â†’ attached to dev-orders-topic
* DLQ configured to dev-dlq-topic

---

# ğŸ¯ This is 100% consistent with your GCS pattern

âœ” map(object)
âœ” for_each
âœ” each.key naming
âœ” dynamic block
âœ” project_id passed
âœ” strict typing
âœ” keys() outputs

---

If you want next, I can now give you:

* Secret Manager module in same pattern
* Artifact Registry module in same pattern
* Vertex/Dataform/Dataplex API enable module in same pattern
* IAM binding support for pubsub

Tell me which service you want next.
