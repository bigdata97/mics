Perfect üëç Let‚Äôs verify everything using **gcloud CLI** step-by-step.

You want to confirm:

1. ‚úÖ What is the Pub/Sub service account?
2. ‚úÖ Does it have KMS permission?
3. ‚úÖ If not, add it (if you have permission)

---

# üîπ STEP 1 ‚Äî Get Your Project Number

Pub/Sub service account uses **project number**, not project ID.

```bash
gcloud projects describe hcb-nonprod-mics \
  --format="value(projectNumber)"
```

Example output:

```
12536452211
```

---

# üîπ STEP 2 ‚Äî Construct Pub/Sub Service Account

It will always be:

```
service-PROJECT_NUMBER@gcp-sa-pubsub.iam.gserviceaccount.com
```

So:

```
service-12536452211@gcp-sa-pubsub.iam.gserviceaccount.com
```

---

# üîπ STEP 3 ‚Äî Check If It Has KMS Permission

Now check IAM policy of your **KMS key**.

First identify:

* Key ring name
* Key name
* Location

You selected:

```
gk-hcb-nonprod-mics-us-east4
```

So run:

```bash
gcloud kms keys get-iam-policy gk-hcb-nonprod-mics-us-east4 \
  --keyring=YOUR_KEYRING_NAME \
  --location=us-east4 \
  --project=hcb-nonprod-mics
```

Example:

```bash
gcloud kms keys get-iam-policy gk-hcb-nonprod-mics-us-east4 \
  --keyring=kr-hcb-nonprod-mics \
  --location=us-east4 \
  --project=hcb-nonprod-mics
```

---

## üîç What You Are Looking For

In output, check for:

```
roles/cloudkms.cryptoKeyEncrypterDecrypter
```

And inside it:

```
service-12536452211@gcp-sa-pubsub.iam.gserviceaccount.com
```

---

### ‚úÖ If You See It

You're good. KMS permission exists.

---

### ‚ùå If You Don't See It

That is the reason for your error.

---

# üîπ STEP 4 ‚Äî Add Permission (If You Have Rights)

If you have IAM permission on KMS, run:

```bash
gcloud kms keys add-iam-policy-binding gk-hcb-nonprod-mics-us-east4 \
  --keyring=YOUR_KEYRING_NAME \
  --location=us-east4 \
  --member="serviceAccount:service-12536452211@gcp-sa-pubsub.iam.gserviceaccount.com" \
  --role="roles/cloudkms.cryptoKeyEncrypterDecrypter" \
  --project=hcb-nonprod-mics
```

---

# üîπ STEP 5 ‚Äî Verify Again

Run:

```bash
gcloud kms keys get-iam-policy gk-hcb-nonprod-mics-us-east4 \
  --keyring=YOUR_KEYRING_NAME \
  --location=us-east4 \
  --project=hcb-nonprod-mics \
  --format="table(bindings.role, bindings.members)"
```

You should now see:

```
roles/cloudkms.cryptoKeyEncrypterDecrypter
serviceAccount:service-12536452211@gcp-sa-pubsub.iam.gserviceaccount.com
```

---

# üî• BONUS ‚Äî If You Don't Know Keyring Name

List keyrings:

```bash
gcloud kms keyrings list \
  --location=us-east4 \
  --project=hcb-nonprod-mics
```

Then list keys:

```bash
gcloud kms keys list \
  --keyring=KEYRING_NAME \
  --location=us-east4 \
  --project=hcb-nonprod-mics
```

---

# üöÄ Enterprise Reality (Very Likely in Your Project)

Since you're in `hcb-nonprod-mics`:

* KMS keys are often controlled by Security team
* You may not have permission to modify IAM
* You might get permission denied while adding binding

If so, send this to security team:

```
Please grant role:
roles/cloudkms.cryptoKeyEncrypterDecrypter

To:
service-<project-number>@gcp-sa-pubsub.iam.gserviceaccount.com

On KMS key:
gk-hcb-nonprod-mics-us-east4
Location: us-east4
Project: hcb-nonprod-mics
```

---

# üß† Why This Is Mandatory

When Pub/Sub creates encrypted topic:

```
Pub/Sub ‚Üí Calls KMS ‚Üí Encrypt message
```

If KMS blocks ‚Üí topic creation fails.

---

If you want, I can also:

* Give Terraform code to verify IAM binding
* Show how to test topic creation via CLI
* Explain how this works internally in GCP security model

Just tell me üëç
