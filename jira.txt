import os
import requests
from datetime import datetime, timezone, timedelta

GITHUB_TOKEN = os.environ["GITHUB_TOKEN"]
REPO = os.environ["GITHUB_REPOSITORY"]

headers = {
    "Authorization": f"Bearer {GITHUB_TOKEN}",
    "Accept": "application/vnd.github+json"
}

def fetch_all_branches():
    branches = []
    page = 1

    while True:
        url = f"https://api.github.com/repos/{REPO}/branches"
        params = {"per_page": 100, "page": page}
        resp = requests.get(url, headers=headers, params=params)
        resp.raise_for_status()

        data = resp.json()
        if not data:
            break

        branches.extend(data)
        page += 1

    return branches

branches = fetch_all_branches()
total_branches = len(branches)

stale_cutoff = datetime.now(timezone.utc) - timedelta(days=30)
stale_count = 0

for b in branches:
    commit_url = b["commit"]["url"]
    commit_resp = requests.get(commit_url, headers=headers)
    commit_resp.raise_for_status()

    commit_date = commit_resp.json()["commit"]["committer"]["date"]
    commit_dt = datetime.fromisoformat(commit_date.replace("Z", "+00:00"))

    if commit_dt < stale_cutoff:
        stale_count += 1

summary = f"""
### ðŸŒ¿ Branch Metrics

| Metric | Count |
|------|------|
| Total branches | **{total_branches}** |
| Stale branches (>30 days) | **{stale_count}** |

"""

with open(os.environ["GITHUB_STEP_SUMMARY"], "a") as f:
    f.write(summary)
