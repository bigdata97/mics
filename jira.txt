Perfect ğŸ‘ This is a **baseline infra enabler story** for your **ID Card Excellence project**, and since you already did this for **GCS**, we will follow the same modular Terraform pattern.

We will design this properly for:

* âœ… GCS
* âœ… Pub/Sub
* âœ… Artifact Registry
* âœ… Secret Manager
* âœ… Vertex AI (API enable + baseline)
* âœ… Dataform (API enable)
* âœ… Dataplex (API enable)

And it should:

* Work for **dev & qa**
* Follow **env naming**
* Support CI (plan/apply via GitHub Actions)
* Be modular
* Be reusable for future services

---

# ğŸ¯ TARGET ARCHITECTURE

Your Terraform repo should look like this:

```
terraform-idcard-data-services/
â”‚
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ gcs/
â”‚   â”œâ”€â”€ pubsub/
â”‚   â”œâ”€â”€ artifact_registry/
â”‚   â”œâ”€â”€ secret_manager/
â”‚   â”œâ”€â”€ vertex_ai/
â”‚   â”œâ”€â”€ dataform/
â”‚   â”œâ”€â”€ dataplex/
â”‚
â”œâ”€â”€ environments/
â”‚   â”œâ”€â”€ dev/
â”‚   â”‚   â”œâ”€â”€ main.tf
â”‚   â”‚   â”œâ”€â”€ terraform.tfvars
â”‚   â”‚   â”œâ”€â”€ backend.tf
â”‚   â”‚   â””â”€â”€ providers.tf
â”‚   â”‚
â”‚   â””â”€â”€ qa/
â”‚       â”œâ”€â”€ main.tf
â”‚       â”œâ”€â”€ terraform.tfvars
â”‚       â”œâ”€â”€ backend.tf
â”‚       â””â”€â”€ providers.tf
â”‚
â”œâ”€â”€ versions.tf
â”œâ”€â”€ variables.tf
â””â”€â”€ outputs.tf
```

---

# ğŸ§© MODULE DESIGN (Production-Ready Structure)

---

# 1ï¸âƒ£ GCS MODULE (Already done â€“ reuse pattern)

modules/gcs/main.tf

```hcl
resource "google_storage_bucket" "this" {
  name     = var.bucket_name
  location = var.location

  uniform_bucket_level_access = true

  labels = var.labels

  lifecycle_rule {
    condition {
      age = var.retention_days
    }
    action {
      type = "Delete"
    }
  }
}
```

variables.tf

```hcl
variable "bucket_name" {}
variable "location" {}
variable "labels" { type = map(string) }
variable "retention_days" { type = number }
```

---

# 2ï¸âƒ£ PUB/SUB MODULE

modules/pubsub/main.tf

```hcl
resource "google_pubsub_topic" "topic" {
  name   = var.topic_name
  labels = var.labels
}

resource "google_pubsub_subscription" "subscription" {
  name  = var.subscription_name
  topic = google_pubsub_topic.topic.id

  message_retention_duration = var.retention_duration
}
```

variables.tf

```hcl
variable "topic_name" {}
variable "subscription_name" {}
variable "retention_duration" {}
variable "labels" { type = map(string) }
```

---

# 3ï¸âƒ£ ARTIFACT REGISTRY MODULE

modules/artifact_registry/main.tf

```hcl
resource "google_artifact_registry_repository" "repo" {
  location      = var.location
  repository_id = var.repository_id
  description   = var.description
  format        = var.format
  labels        = var.labels
}
```

variables.tf

```hcl
variable "location" {}
variable "repository_id" {}
variable "description" {}
variable "format" { default = "DOCKER" }
variable "labels" { type = map(string) }
```

---

# 4ï¸âƒ£ SECRET MANAGER MODULE

modules/secret_manager/main.tf

```hcl
resource "google_secret_manager_secret" "secret" {
  secret_id = var.secret_id

  replication {
    automatic = true
  }

  labels = var.labels
}
```

variables.tf

```hcl
variable "secret_id" {}
variable "labels" { type = map(string) }
```

ğŸ‘‰ If you want IAM bindings:

```hcl
resource "google_secret_manager_secret_iam_binding" "binding" {
  secret_id = google_secret_manager_secret.secret.id
  role      = "roles/secretmanager.secretAccessor"
  members   = var.members
}
```

---

# 5ï¸âƒ£ VERTEX AI MODULE

Mostly API enablement + optional baseline bucket.

```hcl
resource "google_project_service" "vertex" {
  service = "aiplatform.googleapis.com"
}
```

Optional baseline SA:

```hcl
resource "google_service_account" "vertex_sa" {
  account_id   = "vertex-sa"
  display_name = "Vertex AI Service Account"
}
```

---

# 6ï¸âƒ£ DATAFORM MODULE

```hcl
resource "google_project_service" "dataform" {
  service = "dataform.googleapis.com"
}
```

---

# 7ï¸âƒ£ DATAPLEX MODULE

```hcl
resource "google_project_service" "dataplex" {
  service = "dataplex.googleapis.com"
}
```

---

# ğŸ— ENVIRONMENT LEVEL (dev/main.tf)

```hcl
module "gcs" {
  source = "../../modules/gcs"

  bucket_name    = "idcard-${var.env}-data-bucket"
  location       = var.region
  retention_days = 30
  labels         = local.common_labels
}

module "pubsub" {
  source = "../../modules/pubsub"

  topic_name         = "idcard-${var.env}-events"
  subscription_name  = "idcard-${var.env}-events-sub"
  retention_duration = "604800s"
  labels             = local.common_labels
}

module "artifact_registry" {
  source = "../../modules/artifact_registry"

  location      = var.region
  repository_id = "idcard-${var.env}-repo"
  description   = "Docker repo for ID card services"
  labels        = local.common_labels
}

module "vertex_ai" {
  source = "../../modules/vertex_ai"
}
```

---

# ğŸ· Common Labels

```
locals {
  common_labels = {
    project     = "id-card-excellence"
    environment = var.env
    owner       = "platform-team"
  }
}
```

---

# ğŸ” backend.tf (Remote State in GCS)

```hcl
terraform {
  backend "gcs" {
    bucket = "idcard-terraform-state"
    prefix = "data-services/dev"
  }
}
```

---

# ğŸš€ GitHub Actions Plan / Apply

plan.yml

```yaml
- name: Terraform Init
  run: terraform init

- name: Terraform Plan
  run: terraform plan -var-file=terraform.tfvars
```

apply.yml

```yaml
- name: Terraform Apply
  run: terraform apply -auto-approve -var-file=terraform.tfvars
```

---

# âœ… Acceptance Criteria Mapping

| Story AC                                | How we satisfy                 |
| --------------------------------------- | ------------------------------ |
| Storage & PubSub created with retention | Lifecycle + retention_duration |
| Artifact Registry + Secret Manager IAM  | IAM binding resource           |
| APIs enabled                            | google_project_service         |
| Plan/apply works in dev/qa              | env folder separation          |

---

# ğŸ¯ What You Should Do Now (Step-by-Step)

1. Copy your GCS module pattern
2. Create remaining modules exactly like above
3. Create dev and qa environment folders
4. Add backend
5. Run locally:

```
terraform init
terraform plan -var-file=terraform.tfvars
```

6. Push and test via GitHub Actions

---

# ğŸ’¡ Pro Tip (Enterprise Clean Design)

Instead of enabling APIs in every module, create:

```
modules/project_services/
```

and enable all APIs centrally:

```hcl
resource "google_project_service" "services" {
  for_each = toset(var.services)
  service  = each.value
}
```

Then pass:

```hcl
services = [
  "aiplatform.googleapis.com",
  "dataform.googleapis.com",
  "dataplex.googleapis.com"
]
```

This is cleaner architecture.

---

# ğŸ Final Outcome

After this:

âœ” Terraform repo fully modular
âœ” Environment based
âœ” Supports CI
âœ” Enterprise naming
âœ” Matches ID Card Excellence architecture
âœ” Easily extendable

---

If you want, I can now:

* ğŸ”¥ Give you the FULL ready-to-copy Terraform repo structure
* ğŸ”¥ Or give you production-grade version with IAM best practices
* ğŸ”¥ Or help you create the JIRA update content for this story

Tell me which one you want next.
