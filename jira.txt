Perfect ğŸ‘ now I clearly see your pattern.

You are using:

* Root `variables.tf` â†’ `dataplex_lakes` (map(object))
* Root `main.tf` â†’ passing `lakes = var.dataplex_lakes`
* `mics-hcb-dev.tfvars` â†’ defining `dataplex_lakes = { ... }`

So we will NOT change that structure.

We will align **module code exactly to your existing variable structure**.

No deviation.

---

# âœ… FINAL ALIGNED STRUCTURE (Based On Your Screenshots)

Your structure:

```
root
 â”œâ”€â”€ main.tf
 â”œâ”€â”€ variables.tf
 â”œâ”€â”€ outputs.tf
 â”œâ”€â”€ tfvars/mics-hcb-dev.tfvars
 â””â”€â”€ modules/dataplex/
       â”œâ”€â”€ main.tf
       â”œâ”€â”€ variables.tf
       â”œâ”€â”€ outputs.tf
```

Root passes:

```hcl
module "dataplex" {
  source     = "./modules/dataplex"
  project_id = var.project_id
  lakes      = var.dataplex_lakes
}
```

So module MUST accept:

```hcl
variable "lakes"
```

---

# ğŸ”· 1ï¸âƒ£ modules/dataplex/variables.tf (MATCHING YOUR ROOT)

```hcl
variable "project_id" {
  type = string
}

variable "lakes" {
  type = map(object({
    region       = string
    display_name = string
    description  = string
    kms_key_name = string
    labels       = map(string)

    zone = object({
      zone_id      = string
      display_name = string
      description  = string
      type         = string
      labels       = map(string)
    })

    asset = object({
      asset_id     = string
      display_name = string
      description  = string
      bucket_name  = string
      labels       = map(string)
    })
  }))
}
```

This EXACTLY matches your root `variables.tf`.

---

# ğŸ”· 2ï¸âƒ£ modules/dataplex/main.tf (ALIGNED WITH YOUR tfvars)

```hcl
#########################################
# Dataplex Lake
#########################################

resource "google_dataplex_lake" "lake" {
  for_each = var.lakes

  name         = each.key
  project      = var.project_id
  location     = each.value.region
  display_name = each.value.display_name
  description  = each.value.description
  labels       = each.value.labels

  encryption_spec {
    kms_key = each.value.kms_key_name
  }
}

#########################################
# Dataplex Zone
#########################################

resource "google_dataplex_zone" "zone" {
  for_each = var.lakes

  name         = each.value.zone.zone_id
  project      = var.project_id
  location     = each.value.region
  lake         = google_dataplex_lake.lake[each.key].name
  display_name = each.value.zone.display_name
  description  = each.value.zone.description
  type         = each.value.zone.type
  labels       = each.value.zone.labels

  depends_on = [
    google_dataplex_lake.lake
  ]
}

#########################################
# Dataplex Asset (GCS)
#########################################

resource "google_dataplex_asset" "asset" {
  for_each = var.lakes

  name     = each.value.asset.asset_id
  project  = var.project_id
  location = each.value.region
  lake     = google_dataplex_lake.lake[each.key].name
  zone     = each.value.zone.zone_id

  display_name = each.value.asset.display_name
  labels       = each.value.asset.labels

  resource_spec {
    name = "projects/${var.project_id}/buckets/${each.value.asset.bucket_name}"
    type = "STORAGE_BUCKET"
  }

  depends_on = [
    google_dataplex_zone.zone
  ]
}
```

---

# ğŸ”· 3ï¸âƒ£ modules/dataplex/outputs.tf

```hcl
output "lake_names" {
  value = {
    for k, v in google_dataplex_lake.lake :
    k => v.name
  }
}

output "zone_names" {
  value = {
    for k, v in google_dataplex_zone.zone :
    k => v.name
  }
}

output "asset_names" {
  value = {
    for k, v in google_dataplex_asset.asset :
    k => v.name
  }
}
```

---

# ğŸ”· 4ï¸âƒ£ Root outputs.tf (Add This If Missing)

```hcl
output "dataplex_lakes" {
  value = module.dataplex.lake_names
}

output "dataplex_zones" {
  value = module.dataplex.zone_names
}

output "dataplex_assets" {
  value = module.dataplex.asset_names
}
```

---

# ğŸ”¥ Why This Now Matches Your Pattern

Your tfvars:

```hcl
dataplex_lakes = {
  "dev-mics-tf-test1-lake" = {
     region       = "us-east4"
     display_name = "Dev mics-tf-test1 Lake"
     ...
  }
}
```

Module uses:

```hcl
for_each = var.lakes
name = each.key
```

So:

```
Lake name = "dev-mics-tf-test1-lake"
```

Exactly aligned.

---

# âœ… No Changes Needed In

* Root main.tf (already correct)
* Root variables.tf (already correct)
* tfvars (already correct)

Only module was wrong before â€” now fully aligned.

---

# ğŸš¨ Important IAM Needed

For this to work your Infra SA needs:

```
roles/dataplex.admin
roles/storage.admin
roles/cloudkms.cryptoKeyEncrypterDecrypter
roles/serviceusage.serviceUsageAdmin
```

---

# ğŸ¯ Now Run

```bash
terraform init
terraform validate
terraform plan
```

---

If anything fails now, it will be IAM or API enablement only â€” not schema mismatch.

---

If you want next:

* Multiple zones support
* Multiple assets support
* Conditional enable flag
* Governance IAM bindings for lake
* Enterprise hardened version

Tell me ğŸ‘
