Perfect ğŸ‘Œ this is a **very realistic enterprise setup**.

You want:

* Region: **us-east4**
* CMEK: **Required**
* No Git remote
* Create **Dataform repository**
* Create **Workspace**
* Terraform only (infra layer)

Letâ€™s do this properly.

---

# ğŸ”· 1ï¸âƒ£ What We Will Create in Terraform

Dataform resources supported by Terraform:

### 1ï¸âƒ£ `google_dataform_repository`

Creates the Dataform repository.

### 2ï¸âƒ£ `google_dataform_repository_workspace`

Creates a workspace inside repository.

---

# ğŸ”· 2ï¸âƒ£ Important CMEK Requirement

Since your org enforces CMEK:

We must attach:

```hcl
kms_key_name = "projects/.../cryptoKeys/..."
```

AND grant KMS permission to:

```
service-${PROJECT_NUMBER}@gcp-sa-dataform.iam.gserviceaccount.com
```

Otherwise Terraform will fail.

---

# ğŸ”· 3ï¸âƒ£ Final File Structure (Same Pattern as Yours)

```
modules/
  dataform/
    main.tf
    variables.tf
    outputs.tf

root/
  main.tf
  variables.tf

tfvars/
  mics-hcb-dev.tfvars
```

---

# ğŸ“ modules/dataform/main.tf

```hcl id="df_main_tf"
resource "google_dataform_repository" "this" {
  for_each = var.repositories

  project        = var.project_id
  region         = each.value.region
  name           = each.key
  display_name   = each.value.display_name
  kms_key_name   = each.value.kms_key_name
}

resource "google_dataform_repository_workspace" "this" {
  for_each = var.repositories

  project      = var.project_id
  region       = each.value.region
  repository   = google_dataform_repository.this[each.key].name
  name         = each.value.workspace_name
}
```

---

# ğŸ“ modules/dataform/variables.tf

```hcl id="df_variables_tf"
variable "project_id" {
  type        = string
  description = "Project ID"
}

variable "repositories" {
  type = map(object({
    region          = string
    display_name    = string
    kms_key_name    = string
    workspace_name  = string
  }))
}
```

---

# ğŸ“ modules/dataform/outputs.tf

```hcl id="df_outputs_tf"
output "repository_names" {
  value = keys(google_dataform_repository.this)
}

output "workspace_names" {
  value = [
    for k, v in google_dataform_repository_workspace.this :
    v.name
  ]
}
```

---

# ğŸ“ root/main.tf (ADD MODULE)

```hcl id="df_root_main"
module "dataform" {
  source = "./modules/dataform"

  project_id   = var.project_id
  repositories = var.dataform_repositories
}
```

---

# ğŸ“ root/variables.tf (ADD VARIABLE)

```hcl id="df_root_variables"
variable "dataform_repositories" {
  type = map(object({
    region          = string
    display_name    = string
    kms_key_name    = string
    workspace_name  = string
  }))
}
```

---

# ğŸ“ tfvars/mics-hcb-dev.tfvars

Use SAME KMS key as your other services.

```hcl id="df_tfvars"
dataform_repositories = {

  "dev-mics-dataform-repo" = {
    region         = "us-east4"
    display_name   = "Dev MICS Dataform Repository"

    kms_key_name   = "projects/cvs-key-vault-nonprod/locations/us-east4/keyRings/gkr-nonprod-us-east4/cryptoKeys/gk-hcb-nonprod-mics-us-east4"

    workspace_name = "dev-workspace"
  }

}
```

---

# ğŸ”´ VERY IMPORTANT â€” Grant CMEK Permission

Run this ONCE:

```bash
PROJECT_NUMBER=$(gcloud projects describe hcb-nonprod-mics --format="value(projectNumber)")

gcloud kms keys add-iam-policy-binding gk-hcb-nonprod-mics-us-east4 \
  --keyring=gkr-nonprod-us-east4 \
  --location=us-east4 \
  --member="serviceAccount:service-${PROJECT_NUMBER}@gcp-sa-dataform.iam.gserviceaccount.com" \
  --role="roles/cloudkms.cryptoKeyEncrypterDecrypter"
```

If you skip this â†’ Terraform will fail.

---

# ğŸ”· What Terraform Will Now Do

âœ” Create Dataform repository
âœ” Encrypt with CMEK
âœ” Create workspace
âœ” No Git integration
âœ” No IAM bindings
âœ” Fully org-policy compliant

---

# ğŸ”· After Terraform Apply

In UI:

Console â†’ Dataform
You will see:

* dev-mics-dataform-repo
* Workspace: dev-workspace

Ready for SQL development.

---

# ğŸ”¥ You Now Have

âœ” GCS
âœ” PubSub
âœ” Artifact Registry (CMEK)
âœ” Secret Manager (CMEK)
âœ” Dataform (CMEK)

Your infra baseline is becoming enterprise grade.

---

Next in story:

* Dataplex?
* Vertex AI?
* Enable APIs module?
* Service Accounts module?

Tell me what we implement next.
