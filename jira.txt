Perfect ğŸ‘
Weâ€™ll implement **Secret Manager module** exactly like your other modules:

âœ” for_each pattern
âœ” map(object()) variable structure
âœ” User-managed replication
âœ” CMEK required
âœ” No IAM bindings
âœ” Only create secret (NO secret version)

This will fully comply with your org policy.

---

# ğŸ“ modules/secretmanager/main.tf

```hcl
resource "google_secret_manager_secret" "this" {
  for_each = var.secrets

  project   = var.project_id
  secret_id = each.key

  labels = each.value.labels

  replication {
    user_managed {
      dynamic "replicas" {
        for_each = each.value.replication_regions
        content {
          location = replicas.value

          customer_managed_encryption {
            kms_key_name = each.value.kms_key_name
          }
        }
      }
    }
  }
}
```

---

# ğŸ“ modules/secretmanager/variables.tf

```hcl
variable "project_id" {
  type        = string
  description = "Project ID"
}

variable "secrets" {
  type = map(object({
    replication_regions = list(string)
    kms_key_name        = string
    labels              = map(string)
  }))
}
```

---

# ğŸ“ modules/secretmanager/outputs.tf

```hcl
output "secret_names" {
  value = keys(google_secret_manager_secret.this)
}
```

---

# ğŸ“ root/main.tf (ADD MODULE)

```hcl
module "secretmanager" {
  source = "./modules/secretmanager"

  project_id = var.project_id
  secrets    = var.secrets
}
```

---

# ğŸ“ root/variables.tf (ADD THIS VARIABLE)

```hcl
variable "secrets" {
  type = map(object({
    replication_regions = list(string)
    kms_key_name        = string
    labels              = map(string)
  }))
}
```

---

# ğŸ“ tfvars/mics-hcb-dev.tfvars (ADD SAMPLE SECRET)

Use same KMS key you used for GCS / Artifact Registry (must be same region).

```hcl
secrets = {

  "dev-mics-db-password" = {
    replication_regions = ["us-east4"]

    kms_key_name = "projects/cvs-key-vault-nonprod/locations/us-east4/keyRings/gkr-nonprod-us-east4/cryptoKeys/gk-hcb-nonprod-mics-us-east4"

    labels = {
      environment = "dev"
      managed-by  = "terraform"
      application = "mics"
    }
  }

}
```

---

# ğŸš¨ VERY IMPORTANT (CMEK Permission Requirement)

You MUST grant KMS access to Secret Manager service account.

Grant:

```bash
gcloud kms keys add-iam-policy-binding gk-hcb-nonprod-mics-us-east4 \
  --keyring=gkr-nonprod-us-east4 \
  --location=us-east4 \
  --member="serviceAccount:service-<PROJECT_NUMBER>@gcp-sa-secretmanager.iam.gserviceaccount.com" \
  --role="roles/cloudkms.cryptoKeyEncrypterDecrypter"
```

Replace `<PROJECT_NUMBER>` with:

```bash
gcloud projects describe hcb-nonprod-mics --format="value(projectNumber)"
```

If you skip this, Terraform will fail with KMS permission error.

---

# ğŸ§  What This Module Does

Terraform will:

âœ” Create Secret
âœ” Use user-managed replication
âœ” Encrypt with CMEK
âœ” Add labels
âœ” NOT create any secret versions
âœ” NOT add IAM bindings

---

# ğŸ§ª After Apply

You will see in UI:

Secret Manager â†’ Secret â†’
Replication: User Managed
Location: us-east4
Encryption: Customer Managed (CMEK)

---

# ğŸ¯ Enterprise Ready

Now your baseline covers:

âœ” GCS (CMEK)
âœ” PubSub
âœ” Artifact Registry (CMEK)
âœ” Secret Manager (CMEK)

You are building proper foundation infra.

---

Next from your story:

* Vertex AI APIs enable module?
* Dataform baseline?
* Dataplex baseline?

Tell me which one we do next.
