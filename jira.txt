Perfect üëç ‚Äî below is your **Confluence-ready version** of the same **QA Environment Setup Guide** for your **HCB-NonProd-MICS (ID Card Excellence)** project.

This version uses **Confluence macros**, collapsible sections, and `{code}` blocks for commands ‚Äî so you can **copy-paste directly** into your Confluence page and it will automatically format beautifully with expandable sections, syntax highlighting, and tables.

---

# üß≠ QA Environment Setup ‚Äî *HCB-NonProd-MICS (ID Card Excellence)*

---

## üßæ Overview

The purpose of this document is to outline the **end-to-end setup** for the **QA environment** of the *ID Card Excellence* microservices project (`hcb-nonprod-mics`).

This setup includes:

* Creation of a dedicated **QA namespace**
* **Service Account** creation and IAM permissions
* Annotated access for **Workload Identity Federation**
* Setup of **MICS_QA Client in PingID**
* Configuration of **QA hostname and redirect URIs**
* Access provisioning for DevOps, QA, and Developers
* Validation through **ArgoCD deployment**

---

## üß© Prerequisites

* Access to GCP Console with role: *Project Editor or higher*
* Access to **PingID Admin Console**
* GitHub repo permissions for workflow configuration
* ArgoCD access for application deployment
* GKE cluster access via:
  {code:bash}
  gcloud container clusters get-credentials mics-nonprod-gke --region us-central1 --project hcb-nonprod-mics
  {code}

---

## üèóÔ∏è Step 1 ‚Äî Create QA Namespace

{expand:title=Click to view commands}
Create the QA namespace to isolate application resources.
{code:bash}
kubectl create namespace mics-nonprod-qa
{code}

**Verify:**
{code:bash}
kubectl get namespaces
{code}

**Expected Output:**

```
NAME                STATUS   AGE
default             Active   12d
mics-nonprod-dev    Active   10d
mics-nonprod-qa     Active   2s
```

{expand}

---

## üîê Step 2 ‚Äî Create Service Account

{expand:title=Click to view commands}
Create a service account specific to the QA environment.

{code:bash}
gcloud iam service-accounts create qa-idcard-app-sa 
--description="Service Account for MICS QA environment" 
--display-name="QA ID Card Application SA"
{code}

**Verify:**
{code:bash}
gcloud iam service-accounts list | grep qa-idcard-app-sa
{code}
{expand}

---

## üß∞ Step 3 ‚Äî Assign IAM Roles

{expand:title=Click to view commands and roles}
Assign the following IAM roles for GCP resource access.

| Role                                 | Purpose                              |
| ------------------------------------ | ------------------------------------ |
| `roles/storage.admin`                | Manage GCS buckets and lifecycle     |
| `roles/storage.objectAdmin`          | Read/write objects in QA GCS buckets |
| `roles/run.invoker`                  | Invoke Cloud Run services            |
| `roles/secretmanager.secretAccessor` | Access environment-specific secrets  |
| `roles/logging.logWriter`            | Write application logs               |
| `roles/monitoring.viewer`            | Read metrics                         |
| `roles/pubsub.editor`                | Manage Pub/Sub topics                |

{code:bash}
PROJECT_ID=hcb-nonprod-mics
SA_EMAIL=qa-idcard-app-sa@$PROJECT_ID.iam.gserviceaccount.com

gcloud projects add-iam-policy-binding $PROJECT_ID 
--member="serviceAccount:$SA_EMAIL" 
--role="roles/storage.admin"

gcloud projects add-iam-policy-binding $PROJECT_ID 
--member="serviceAccount:$SA_EMAIL" 
--role="roles/run.invoker"

gcloud projects add-iam-policy-binding $PROJECT_ID 
--member="serviceAccount:$SA_EMAIL" 
--role="roles/secretmanager.secretAccessor"
{code}
{expand}

---

## üßæ Step 4 ‚Äî Annotate Service Account (Workload Identity)

{expand:title=Click to view details}
This step links the GKE SA to the GCP IAM SA using **Workload Identity Federation**.

{code:bash}
kubectl annotate serviceaccount qa-idcard-app-sa 
iam.gke.io/gcp-service-account=[qa-idcard-app-sa@hcb-nonprod-mics.iam.gserviceaccount.com](mailto:qa-idcard-app-sa@hcb-nonprod-mics.iam.gserviceaccount.com) 
-n mics-nonprod-qa
{code}

‚úÖ This allows pods in `mics-nonprod-qa` to securely impersonate the IAM SA without JSON keys.
{expand}

---

## üåê Step 5 ‚Äî Configure PingID Client

{expand:title=Click to view steps}

1. Log in to **PingID Admin Console** ‚Üí *Applications ‚Üí Add Application ‚Üí OpenID Connect*

2. Create a new client:

   * **Client Name:** `MICS_QA`
   * **Grant Type:** `authorization_code`
   * **Scopes:** `openid profile email`
   * **Environment:** `QA`

3. Add **Redirect URIs:**

   ```
   https://mics-nonprod-qa.cvshealth.com/callback
   https://mics-nonprod-qa.cvshealth.com/login/oauth2/code
   ```

4. Note down `Client ID` and `Client Secret`.

5. Create secret in QA namespace:
   {code:bash}
   kubectl create secret generic pingid-qa-credentials 
   --from-literal=CLIENT_ID=<client-id> 
   --from-literal=CLIENT_SECRET=<client-secret> 
   -n mics-nonprod-qa
   {code}
   {expand}

---

## üåç Step 6 ‚Äî Create QA Hostname and Redirect URI

{expand:title=Click to view details}
**Hostname:**

```
mics-nonprod-qa.cvshealth.com
```

**Steps:**

1. Create DNS record mapping hostname ‚Üí Internal Ingress Gateway IP.
2. Update Istio VirtualService YAML:
   {code:yaml}
   hosts:

   * mics-nonprod-qa.cvshealth.com
     gateways:
   * istio-system/internal-ingressgateway
     {code}
3. Add redirect URI in PingID:

   ```
   https://mics-nonprod-qa.cvshealth.com/callback
   ```

{expand}

---

## üë• Step 7 ‚Äî Provide Access

{expand:title=Click to view access table}

| User/Group   | Role  | Namespace       | Notes                  |
| ------------ | ----- | --------------- | ---------------------- |
| QA Engineers | edit  | mics-nonprod-qa | Deploy & test services |
| DevOps       | admin | argocd          | Manage deployments     |
| Developers   | view  | mics-nonprod-qa | View logs/events       |

**Command Example:**
{code:bash}
kubectl create rolebinding qa-edit-access 
--clusterrole=edit 
--user=[qa-team@cvshealth.com](mailto:qa-team@cvshealth.com) 
--namespace=mics-nonprod-qa
{code}
{expand}

---

## üöÄ Step 8 ‚Äî Deploy ArgoCD Application

{expand:title=Click to view YAML}
Apply the ArgoCD application definition to deploy into QA.

{code:bash}
kubectl apply -f application-qa.yaml -n argocd
{code}

**Example Snippet:**
{code:yaml}
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
name: mics-ui-components-app-qa
namespace: argocd
spec:
project: default
source:
repoURL: '[https://github.com/cvshealth/mics-ui-components.git](https://github.com/cvshealth/mics-ui-components.git)'
targetRevision: main
path: manifests/qa
destination:
server: [https://kubernetes.default.svc](https://kubernetes.default.svc)
namespace: mics-nonprod-qa
syncPolicy:
automated:
prune: true
selfHeal: true
{code}
{expand}

---

## üîç Step 9 ‚Äî Validation Checklist

{expand:title=Click to view checklist}

| Task               | Command                                     | Expected Output            |
| ------------------ | ------------------------------------------- | -------------------------- |
| Namespace created  | `kubectl get ns`                            | `mics-nonprod-qa` present  |
| SA exists          | `gcloud iam service-accounts list`          | `qa-idcard-app-sa` present |
| Annotation applied | `kubectl get sa -n mics-nonprod-qa -o yaml` | Annotation visible         |
| ArgoCD app synced  | `argocd app get mics-ui-components-app-qa`  | Synced, Healthy            |
| Host resolves      | `nslookup mics-nonprod-qa.cvshealth.com`    | Ingress IP returned        |
| PingID redirect    | Browser login test                          | Successful callback        |
| {expand}           |                                             |                            |

---

## üìö References

* [GCP IAM Policy Binding Guide](https://cloud.google.com/iam/docs/granting-changing-revoking-access)
* [PingID OIDC Setup Guide (Internal CVS)]()
* [ArgoCD Declarative Setup](https://argo-cd.readthedocs.io/en/stable/operator-manual/declarative-setup/)
* [Istio VirtualService Reference](https://istio.io/latest/docs/reference/config/networking/virtual-service/)

---

## ‚úÖ Summary

| Component         | Action Completed                            |
| ----------------- | ------------------------------------------- |
| Namespace         | Created `mics-nonprod-qa`                   |
| Service Account   | Created `qa-idcard-app-sa` with IAM roles   |
| Workload Identity | Annotated SA for GKE ‚Üî GCP integration      |
| PingID            | Created `MICS_QA` client with redirect URIs |
| Hostname          | Configured `mics-nonprod-qa.cvshealth.com`  |
| ArgoCD            | Deployed QA application                     |
| Verification      | All checks validated successfully           |

---

**üéØ Final Outcome:**
QA environment for **HCB-NonProd-MICS (ID Card Excellence)** is successfully provisioned and integrated with PingID and ArgoCD.
Application accessible via:
üëâ **[https://mics-nonprod-qa.cvshealth.com](https://mics-nonprod-qa.cvshealth.com)**

---

Would you like me to add a **Confluence cover page section** (with document owner, version history, reviewers, and approval table) ‚Äî formatted in standard CVS template style for governance submission?
